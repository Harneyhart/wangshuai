# 使用说明

## 快速开始

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 启动应用
```bash
python app.py
```

### 3. 访问应用
打开浏览器访问：`http://localhost:5000`

## 文件准备

### Word文档
- 支持 `.doc` 和 `.docx` 格式
- 如果是 `.doc` 文件，系统会自动转换为 `.docx` 格式
- 转换后的 `.docx` 文件会自动保存到 `save-word/` 目录

### Excel文件
- 必须是 `.xlsx` 格式
- 第一列：要批注的原文
- 第二列：批注内容
- 至少包含两列数据

## 使用步骤

1. **上传文件**
   - 点击"选择Word文档"按钮，选择要处理的Word文件
   - 点击"选择Excel文件"按钮，选择包含批注数据的Excel文件

2. **处理文件**
   - 点击"上传并处理"按钮
   - 系统会自动处理文件并显示处理结果

3. **下载结果**
   - 处理成功后，可以下载带有批注的Word文档

## 文件保存位置

### 转换后的docx文件
所有从 `.doc` 转换的 `.docx` 文件都会保存在 `save-word/` 目录中：

- **LibreOffice转换**：`converted_原文件名.docx`
- **备用转换**：`converted_原文件名_backup.docx`
- **mammoth转换**：`converted_原文件名_mammoth.docx`
- **python-docx直接转换**：`converted_原文件名_direct.docx`

### 处理后的文档
带有批注的最终文档保存在 `uploads/` 目录中：
- `output_原文件名.docx` 或 `output_原文件名.doc`

## 故障排除

### 常见问题

1. **权限错误**
   - 确保应用有写入权限
   - 关闭可能占用文件的程序（如Word、Excel）

2. **LibreOffice未找到**
   - 安装LibreOffice
   - 检查安装路径是否正确

3. **转换失败**
   - 检查文档是否损坏
   - 尝试使用不同的转换方法

4. **文本匹配失败**
   - 检查Excel中的文本是否与Word文档中的文本一致
   - 系统会自动尝试模糊匹配

### 调试信息

系统会输出详细的调试信息，包括：
- 文件转换过程
- 文档结构分析
- 文本匹配结果
- 错误详情

## 测试功能

### 运行测试脚本
```bash
python test_conversion.py
```

这个脚本会：
- 检查 `uploads/` 目录中的 `.doc` 文件
- 测试转换功能
- 验证转换后的文件
- 检查 `save-word/` 目录中的文件

## 技术细节

### 转换方法优先级
1. LibreOffice转换（主要方法）
2. mammoth库转换
3. python-docx直接读取
4. docx2txt文本提取后重建

### 文本匹配策略
1. 精确匹配
2. 跨运行匹配
3. 模糊匹配（相似度阈值：0.7）

### 文件命名规则
- 上传文件：`UUID_原文件名`
- 转换文件：`converted_原文件名_方法.docx`
- 输出文件：`output_原文件名.docx`

## 注意事项

1. **文件大小限制**：建议文件大小不超过50MB
2. **编码格式**：确保文件使用UTF-8编码
3. **临时文件**：系统会自动清理临时文件
4. **并发处理**：建议一次只处理一个文件 