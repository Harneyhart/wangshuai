# AI Word 文档批注系统

## 项目简介
本项目是一个基于Flask的Web服务，支持上传Word文档和Excel批注表，自动对Word文档内容进行AI智能批注。系统支持多级标题区块划分、上下文感知批注、并发处理、模糊匹配等功能，适用于合同、报告等多种文档场景。

## 主要功能
- **文件支持**：支持上传Word（.doc/.docx）和Excel（.xlsx）文件
- **智能识别**：自动识别多级标题，仅在内容段落插入批注
- **上下文感知**：基于同区块前后文进行智能批注匹配
- **并发处理**：支持多段落并发处理，大幅提升处理速度
- **错误类型识别**：支持日期、数字、名称、格式等多种错误类型
- **批注分类**：自动识别全局性批注和具体错误批注
- **逻辑一致性检查**：避免对逻辑正确的原文进行错误批注
- **自动文件打开**：处理完成后自动打开生成的文档
- **智能分发批注**：系统只会在你上传的Excel批注表中寻找最合适的批注内容，并插入到Word文档的最佳位置。
- **不会自动生成新的批注内容**，只做智能匹配和分发。

## 新增功能特性

### 并发处理
- 支持多段落并发处理，提升处理速度
- 动态调整并发参数（批次大小、最大并发数）
- 根据文档大小和批注数量自动优化配置
- 提供详细的性能统计和加速比分析

### 智能批注分类
- **具体错误批注**：针对特定错误的批注，进行逻辑一致性检查
- **全局性批注**：对整个文档的宏观评价或建议
- **模糊匹配批注**：基于语义相似性的智能匹配

### 性能监控
- 实时显示处理进度和成功率
- 计算加速比和API调用效率
- 提供性能优化建议

## 依赖安装
请确保已安装Python 3.7及以上版本。

```bash
pip install -r requirements.txt
```

**系统要求：**
- Python 3.7+
- LibreOffice（用于.doc文件转换）
- 稳定的网络连接（用于AI API调用）

**注意：**
- `.doc`格式转换依赖本地安装 [LibreOffice](https://www.libreoffice.org/)
- Windows下需保证 `C:\Program Files\LibreOffice\program\soffice.exe` 路径存在
- 需要有效的DeepSeek API Key，请在 `app.py` 第26行配置您的API密钥

## 使用方法
1. 启动服务：
   ```bash
   python app.py
   ```
2. 访问 `http://localhost:5000`，上传Word和Excel文件
3. 系统自动处理并生成带AI批注的Word文档
4. 处理完成后自动打开生成的文档

### Excel批注表格式
- 第一列：序号（用于标识批注）
- 第二列：批注内容（具体要插入的批注文本）
- 所有批注内容都需由用户在Excel表中提前准备，系统不会自动生成批注内容

### 批注类型说明
- **【全局】**：全局性批注，对整个文档的宏观评价
- **【模糊】**：模糊匹配批注，基于语义相似性匹配
- **【未匹配成功】**：无法找到合适匹配的批注

## 配置说明

### 并发处理配置
系统会根据文档大小自动调整并发参数：
- 小文档（≤10段）：批次大小3，并发数4
- 中等文档（≤30段）：批次大小5，并发数6
- 大文档（≤100段）：批次大小8，并发数8
- 超大文档（>100段）：批次大小10，并发数10

### 相似度阈值
- 少量批注（≤5个）：阈值0.3
- 中等批注（≤20个）：阈值0.5
- 大量批注（>20个）：阈值0.6

## 目录结构
```
word-api/
├── app.py              # 主程序
├── requirements.txt    # 依赖包列表
├── README.md          # 项目说明
├── uploads/           # 上传文件目录
├── save-word/         # 转换/中间文件目录
├── templates/         # 网页模板
└── api/              # API相关文件
    ├── templates/     # API模板
    └── w-api.py      # API处理程序
```

## 性能优化建议

### 提升处理速度
1. 增加并发数：修改 `CONCURRENT_CONFIG['max_workers']` 增加并发数可以提升处理速度，适合大文档
2. 优化批次大小：调整 `CONCURRENT_CONFIG['batch_size']` 小文档批次可以小一点，大文档批次可以大一点
3. 检查网络连接：确保API调用稳定

### 提升匹配精度
1. 调整相似度阈值：修改 `CONCURRENT_CONFIG['threshold']` 批注少，阈值低，尽量都能匹配上；批注多，阈值高，尽量准确
2. 优化批注内容：确保批注描述准确具体
3. 检查文档格式：确保文档结构清晰

## 常见问题

### 性能问题
- **加速比低**：检查网络连接，考虑增加并发数
- **API调用失败**：检查API密钥和网络连接
- **处理超时**：减少并发数或增加超时时间

### 功能问题
- **LibreOffice未安装**：下载安装LibreOffice并确保路径正确
- **API密钥无效**：更新 `app.py` 中的DeepSeek API密钥
- **文件格式错误**：确保上传的文件格式正确

### 批注问题
- **批注未插入**：检查相似度阈值和批注内容
- **逻辑一致性错误**：检查批注内容的准确性

### AI不会自动生成批注
- 如果某些内容未被批注，请检查Excel批注表中是否有对应的批注内容

## 更新日志

### v2.0.0 (最新)
- 新增并发处理功能，大幅提升处理速度
- 新增性能统计和优化建议
- 新增智能批注分类（全局/具体错误）
- 新增逻辑一致性检查
- 优化错误处理和用户体验
- 支持 WPS 和 Word 

### v1.0.0
- 基础批注功能
- 多级标题识别
- 上下文感知匹配
- 文件格式转换支持
